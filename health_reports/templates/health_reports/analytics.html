{% extends 'health_reports/base.html' %}


{% comment %} {% extends 'health_reports/base.html' %}

{% block title %}Analytics - Climate Health Tracker{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="fas fa-chart-line"></i> Analytics Dashboard</h2>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Reports by Disease Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="diseaseChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Reports by Environmental Cause</h5>
                </div>
                <div class="card-body">
                    <canvas id="causeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Report Trends (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Reports by Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Top 10 Affected Locations</h5>
                </div>
                <div class="card-body">
                    <canvas id="locationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Parse data from Django template
    const diseaseData = JSON.parse('{{ disease_data|safe }}');
    const causeData = JSON.parse('{{ cause_data|safe }}');
    const statusData = JSON.parse('{{ status_data|safe }}');
    const timeData = JSON.parse('{{ time_data|safe }}');
    const locationData = JSON.parse('{{ location_data|safe }}');

    // Disease Type Chart
    const diseaseLabels = diseaseData.map(item => {
        const types = {
            'respiratory': 'Respiratory',
            'waterborne': 'Waterborne',
            'vector': 'Vector-borne',
            'heat_related': 'Heat-related',
            'skin': 'Skin',
            'cardiovascular': 'Cardiovascular',
            'mental_health': 'Mental Health',
            'other': 'Other'
        };
        return types[item.disease_type] || item.disease_type;
    });
    const diseaseCounts = diseaseData.map(item => item.count);

    new Chart(document.getElementById('diseaseChart'), {
        type: 'doughnut',
        data: {
            labels: diseaseLabels,
            datasets: [{
                data: diseaseCounts,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Environmental Cause Chart
    const causeLabels = causeData.map(item => {
        const causes = {
            'air_pollution': 'Air Pollution',
            'water_contamination': 'Water Contamination',
            'heatwave': 'Heatwave',
            'flooding': 'Flooding',
            'drought': 'Drought',
            'poor_sanitation': 'Poor Sanitation',
            'waste_pollution': 'Waste Pollution',
            'climate_stress': 'Climate Stress',
            'unknown': 'Unknown'
        };
        return causes[item.environmental_cause] || item.environmental_cause;
    });
    const causeCounts = causeData.map(item => item.count);

    new Chart(document.getElementById('causeChart'), {
        type: 'bar',
        data: {
            labels: causeLabels,
            datasets: [{
                label: 'Number of Reports',
                data: causeCounts,
                backgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Trend Chart
    const trendLabels = timeData.map(item => item.date);
    const trendCounts = timeData.map(item => item.count);

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Reports',
                data: trendCounts,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Status Chart
    const statusLabels = statusData.map(item => {
        const statuses = {
            'pending': 'Pending',
            'verified': 'Verified',
            'investigating': 'Investigating',
            'resolved': 'Resolved',
            'rejected': 'Rejected'
        };
        return statuses[item.status] || item.status;
    });
    const statusCounts = statusData.map(item => item.count);

    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusCounts,
                backgroundColor: ['#FFC107', '#17A2B8', '#007BFF', '#28A745', '#DC3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Location Chart
    const locationLabels = locationData.map(item => item.location);
    const locationCounts = locationData.map(item => item.count);

    new Chart(document.getElementById('locationChart'), {
        type: 'bar',
        data: {
            labels: locationLabels,
            datasets: [{
                label: 'Number of Reports',
                data: locationCounts,
                backgroundColor: '#FF6384'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %} {% endcomment %}



{% block title %}Analytics - Climate Health Tracker{% endblock %}

{% block content %}
<style>
    .analytics-wrapper {
        background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .analytics-header {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .analytics-header h2 {
        margin: 0;
        color: #2e7d32;
        font-weight: 600;
        font-size: 2rem;
    }
    
    .analytics-icon {
        font-size: 2.5rem;
    }
    
    .chart-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        border: none;
        overflow: hidden;
        margin-bottom: 2rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.15);
    }
    
    .chart-card-header {
        padding: 1.5rem;
        border: none;
        color: white;
        font-weight: 600;
    }
    
    .chart-card-header h5 {
        margin: 0;
        font-size: 1.1rem;
    }
    
    .header-green {
        background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
    }
    
    .header-teal {
        background: linear-gradient(135deg, #00897b 0%, #26a69a 100%);
    }
    
    .header-blue {
        background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
    }
    
    .header-amber {
        background: linear-gradient(135deg, #f57f17 0%, #fbc02d 100%);
    }
    
    .header-forest {
        background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
    }
    
    .chart-card-body {
        padding: 2rem;
    }
    
    .row {
        margin-left: -1rem;
        margin-right: -1rem;
    }
    
    .col-md-6, .col-md-12 {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    canvas {
        max-height: 400px;
    }
</style>

<div class="analytics-wrapper">
    <div class="container-fluid">
        <div class="analytics-header">
            <div class="analytics-icon">üìä</div>
            <h2>Analytics Dashboard</h2>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card chart-card">
                    <div class="card-header chart-card-header header-green">
                        <h5>üìà Reports by Disease Type</h5>
                    </div>
                    <div class="card-body chart-card-body">
                        <canvas id="diseaseChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card chart-card">
                    <div class="card-header chart-card-header header-teal">
                        <h5>üåç Reports by Environmental Cause</h5>
                    </div>
                    <div class="card-body chart-card-body">
                        <canvas id="causeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card chart-card">
                    <div class="card-header chart-card-header header-blue">
                        <h5>üìâ Report Trends (Last 30 Days)</h5>
                    </div>
                    <div class="card-body chart-card-body">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card chart-card">
                    <div class="card-header chart-card-header header-amber">
                        <h5>‚ö° Reports by Status</h5>
                    </div>
                    <div class="card-body chart-card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card chart-card">
                    <div class="card-header chart-card-header header-forest">
                        <h5>üìç Top 10 Affected Locations</h5>
                    </div>
                    <div class="card-body chart-card-body">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Parse data from Django template
    const diseaseData = JSON.parse('{{ disease_data|safe }}');
    const causeData = JSON.parse('{{ cause_data|safe }}');
    const statusData = JSON.parse('{{ status_data|safe }}');
    const timeData = JSON.parse('{{ time_data|safe }}');
    const locationData = JSON.parse('{{ location_data|safe }}');

    // Green-themed color palette
    const greenPalette = [
        '#2e7d32', '#43a047', '#66bb6a', '#81c784',
        '#a5d6a7', '#00897b', '#26a69a', '#4db6ac'
    ];
    
    const statusColors = {
        'pending': '#fbc02d',
        'verified': '#42a5f5',
        'investigating': '#5c6bc0',
        'resolved': '#66bb6a',
        'rejected': '#ef5350'
    };

    // Disease Type Chart
    const diseaseLabels = diseaseData.map(item => {
        const types = {
            'respiratory': 'Respiratory',
            'waterborne': 'Waterborne',
            'vector': 'Vector-borne',
            'heat_related': 'Heat-related',
            'skin': 'Skin',
            'cardiovascular': 'Cardiovascular',
            'mental_health': 'Mental Health',
            'other': 'Other'
        };
        return types[item.disease_type] || item.disease_type;
    });
    const diseaseCounts = diseaseData.map(item => item.count);

    new Chart(document.getElementById('diseaseChart'), {
        type: 'doughnut',
        data: {
            labels: diseaseLabels,
            datasets: [{
                data: diseaseCounts,
                backgroundColor: greenPalette,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // Environmental Cause Chart
    const causeLabels = causeData.map(item => {
        const causes = {
            'air_pollution': 'Air Pollution',
            'water_contamination': 'Water Contamination',
            'heatwave': 'Heatwave',
            'flooding': 'Flooding',
            'drought': 'Drought',
            'poor_sanitation': 'Poor Sanitation',
            'waste_pollution': 'Waste Pollution',
            'climate_stress': 'Climate Stress',
            'unknown': 'Unknown'
        };
        return causes[item.environmental_cause] || item.environmental_cause;
    });
    const causeCounts = causeData.map(item => item.count);

    new Chart(document.getElementById('causeChart'), {
        type: 'bar',
        data: {
            labels: causeLabels,
            datasets: [{
                label: 'Number of Reports',
                data: causeCounts,
                backgroundColor: '#26a69a',
                borderRadius: 8,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Trend Chart
    const trendLabels = timeData.map(item => item.date);
    const trendCounts = timeData.map(item => item.count);

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Reports',
                data: trendCounts,
                borderColor: '#43a047',
                backgroundColor: 'rgba(67, 160, 71, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#43a047',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Status Chart
    const statusLabels = statusData.map(item => {
        const statuses = {
            'pending': 'Pending',
            'verified': 'Verified',
            'investigating': 'Investigating',
            'resolved': 'Resolved',
            'rejected': 'Rejected'
        };
        return statuses[item.status] || item.status;
    });
    const statusCounts = statusData.map(item => item.count);
    const statusChartColors = statusLabels.map(label => {
        const colorMap = {
            'Pending': statusColors.pending,
            'Verified': statusColors.verified,
            'Investigating': statusColors.investigating,
            'Resolved': statusColors.resolved,
            'Rejected': statusColors.rejected
        };
        return colorMap[label] || '#9e9e9e';
    });

    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusCounts,
                backgroundColor: statusChartColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // Location Chart
    const locationLabels = locationData.map(item => item.location);
    const locationCounts = locationData.map(item => item.count);

    new Chart(document.getElementById('locationChart'), {
        type: 'bar',
        data: {
            labels: locationLabels,
            datasets: [{
                label: 'Number of Reports',
                data: locationCounts,
                backgroundColor: '#2e7d32',
                borderRadius: 8,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}